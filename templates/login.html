{% extends 'base.html' %}
{% block title %}{{ 'Register' if register else 'Login' }}{% endblock %}

{% block content %}
<div class="min-h-[60vh] flex items-center justify-center">
  <div class="w-full max-w-md">
    <div class="bg-white rounded-2xl p-6 shadow-sm">
      <div class="flex items-center gap-3 mb-4">
        <div class="rounded-lg p-3 bg-gradient-to-tr from-primary-500 to-accent text-white shadow-soft-lg">
          <i class="fa-solid fa-user"></i>
        </div>
        <div>
          <h2 class="text-xl font-semibold text-slate-900">{{ 'Register' if register else 'Welcome back' }}</h2>
          <p class="text-sm text-slate-500">
            {% if register %}Create a new account to start using Cloud Workspaces.{% else %}Sign in to access your workspaces.{% endif %}
          </p>
        </div>
      </div>

      <form id="loginForm" class="space-y-4" onsubmit="return false;">
        <div>
          <label for="email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
          <input id="email" type="email" required
                 class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-300 transition" />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
          <div class="relative">
            <input id="password" type="password" required
                   class="w-full rounded-lg border border-slate-200 px-3 py-2 pr-10 text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-300 transition" />
            <button type="button" id="pwToggle" aria-label="Show password"
                    class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700">
              <i class="fa-solid fa-eye"></i>
            </button>
          </div>
        </div>

        <div>
          <button id="loginBtn"
                  class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-primary-500 text-white font-medium hover:bg-primary-600 transition">
            <i class="fa-solid fa-arrow-right-to-bracket"></i> Login
          </button>
        </div>
      </form>

      <div class="mt-4 text-center text-sm text-slate-500">
        New here? <a href="#" id="registerLink" class="text-primary-600 font-medium hover:underline">Create account</a>
      </div>

      <div class="mt-5">
        <div class="relative text-center">
          <span class="bg-white px-3 text-xs text-slate-400">or</span>
          <div class="absolute inset-x-0 top-1/2 border-t border-slate-100"></div>
        </div>

        <div class="mt-4 flex gap-3">
          <button id="googleBtn"
                  class="flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-white border border-slate-200 text-sm hover:shadow-sm transition">
            <i class="fa-brands fa-google text-red-500"></i> Google
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase Auth -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDekzwfLNMiwxD2zT6zU6zl2DYaa_PosA",
    authDomain: "cccp-f70e5.firebaseapp.com",
    projectId: "cccp-f70e5",
    storageBucket: "cccp-f70e5.firebasestorage.app",
    messagingSenderId: "462350593543",
    appId: "1:462350593543:web:22c818f1a06d6e3ebcc4a2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  async function sendTokenToBackend(idToken) {
    await fetch("/auth/token-login", {
      method: "POST",
      headers: { "Authorization": "Bearer " + idToken }
    }).then(r => {
      if (r.redirected) window.location.href = r.url;
    });
  }

  document.getElementById('loginBtn').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const user = await signInWithEmailAndPassword(auth, email, password);
    const idToken = await user.user.getIdToken();
    await sendTokenToBackend(idToken);
  };

  document.getElementById('registerLink').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const user = await createUserWithEmailAndPassword(auth, email, password);
    const idToken = await user.user.getIdToken();
    await sendTokenToBackend(idToken);
  };

  document.getElementById('googleBtn').onclick = async () => {
    const result = await signInWithPopup(auth, provider);
    const idToken = await result.user.getIdToken();
    await sendTokenToBackend(idToken);
  };

  // Password toggle
  const pw = document.getElementById('password');
  const btn = document.getElementById('pwToggle');
  btn.addEventListener('click', () => {
    if (pw.type === 'password') {
      pw.type = 'text';
      btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
    } else {
      pw.type = 'password';
      btn.innerHTML = '<i class="fa-solid fa-eye"></i>';
    }
  });
</script>
{% endblock %}
